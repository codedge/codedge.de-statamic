---
title: 'Run a PHP application on AWS Fargate'
author: dae50ec2-e88c-43d0-a926-8d2aaac5ee58
updated_by: dae50ec2-e88c-43d0-a926-8d2aaac5ee58
updated_at: 1607349987
seotamic_title: title
seotamic_title_prepend: true
seotamic_title_append: true
seotamic_meta_description: custom
seotamic_open_graph_title: title
seotamic_open_graph_description: meta
seotamic_twitter_title: title
seotamic_twitter_description: meta
seotamic_custom_meta_description: 'Run a PHP application on AWS Fargate deployed via Github Actions.'
post_content:
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Following the trend of serverless, all that hype (or not?) I was looking through the AWS services offered and stumbled upon '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://aws.amazon.com/fargate/'
              target: _blank
              rel: null
        text: 'AWS Fargate'
      -
        type: text
        text: ', a service that lets you run containerized applications on either '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://aws.amazon.com/ecs/'
              target: _blank
              rel: null
        text: 'Amazon Elastic Container Service (ECS)'
      -
        type: text
        text: ' or '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://aws.amazon.com/eks/'
              target: _blank
              rel: null
        text: 'Amazon Elastic Kubernetes Services (EKS)'
      -
        type: text
        text: .
  -
    type: paragraph
    content:
      -
        type: text
        text: 'For the tooling (development and deployment) of our PHP application I''d like to stick to probably the widely adopted tools, like:'
  -
    type: bullet_list
    content:
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Deployment: '
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: 'https://github.com'
                      target: _blank
                      rel: null
                text: Github
              -
                type: text
                text: ' including Github Actions'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: Infrastructure
              -
                type: text
                text: ': Elastic Container Service (ECS) to run our containers on'
              -
                type: hard_break
              -
                type: text
                text: 'Docker container hosted on '
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: 'https://aws.amazon.com/ecr/'
                      target: _blank
                      rel: null
                text: 'Amazon Elastic Container Registry (ECR)'
              -
                type: hard_break
              -
                type: text
                text: 'Database we''ll be using '
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: 'https://aws.amazon.com/rds/'
                      target: _blank
                      rel: null
                text: 'Amazon RDS'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: Logging
              -
                type: text
                text: ': '
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: 'https://aws.amazon.com/cloudwatch/'
                      target: _blank
                      rel: null
                text: 'Amazon Cloudwatch'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Of course, you''re not bound to this tooling. If you want to use another external database hosted somewhere else than on Amazon, feel free to do. The same applies to logging. You''ve got a working '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://www.graylog.org/'
              target: _blank
              rel: null
        text: Greylog
      -
        type: text
        text: ' up and running then you''re free to use that. These things are not mandatory for AWS Fargate. I just decided to use that for convenience reasons.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'If you want to know about '
      -
        type: text
        marks:
          -
            type: bold
        text: pricing
      -
        type: text
        text: ' of this setup by now, let''s leave it with what advocates usually say: It depends! :wink: To get a general feeling have look at the [costs section]({{< ref "#costs" >}}) of this article. A lot of the (further) costs depend on the pricing.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'For this project/experiment I use Laravel 7. Of course, you can use any framework you''d like to run this application. Just make sure you adjust certain paths for building the Docker images.'
  -
    type: set
    attrs:
      values:
        type: hint
        hint:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'All files can be found in this '
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: 'https://github.com/codedge/aws-fargate-with-php'
                      target: _blank
                      rel: null
                text: 'Github repository'
              -
                type: text
                text: '. Feel free to open issues and PRs if you spot anything wrong.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'The final directory layout:'
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```
          ├── .dockerignore
          ├── .editorconfig
          ├── .env
          ├── .env.example
          ├── .git
          ├── .gitattributes
          ├── .github
          ├── .gitignore
          ├── .idea
          ├── .styleci.yml
          ├── Dockerfile
          ├── app
          ├── artisan
          ├── bootstrap
          ├── composer.json
          ├── composer.lock
          ├── config
          ├── database
          ├── docker
          ├── docker-compose.yml
          ├── node_modules
          ├── package.json
          ├── phpunit.xml
          ├── public
          ├── resources
          ├── routes
          ├── server.php
          ├── storage
          ├── task-definition.json
          ├── tests
          ├── vendor
          ├── webpack.mix.js
          └── yarn.lock
          ```
          
        caption: 'Directory structure of your project'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'So then, let''s get started!'
  -
    type: heading
    attrs:
      level: 2
    content:
      -
        type: text
        text: 'Preparing the Docker images'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'To provide the complete application to AWS Fargate, we''ll split it into three containers:'
  -
    type: bullet_list
    content:
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: Nginx
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: PHP-FPM
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: NodeJS
  -
    type: paragraph
    content:
      -
        type: text
        text: 'For the database we don''t create a separate container as we need a stateful solution. We''ll rely on a '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://docs.docker.com/develop/develop-images/multistage-build/'
              target: _blank
              rel: null
        text: 'multi-stage build'
      -
        type: text
        text: ' as well as on '
      -
        type: text
        marks:
          -
            type: code
        text: alpine
      -
        type: text
        text: ' images only for our Docker images to keep the image sizes extremely small.'
  -
    type: set
    attrs:
      values:
        type: hint
        hint:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Alpine images'
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Fast and small: saving costs when storing with ECR - Less size: less attack surface'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'You can find some comparison and further reading on Alpine images '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://nickjanetakis.com/blog/the-3-biggest-wins-when-using-alpine-as-a-base-docker-image'
              target: _blank
              rel: null
        text: 'in this blog post'
      -
        type: text
        text: ' or on the '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://hub.docker.com/_/alpine'
              target: _blank
              rel: null
        text: 'Alpine docker page'
      -
        type: text
        text: .
      -
        type: hard_break
      -
        type: text
        text: 'Here is an example just to demonstrate the basic usage for our multi-stage build. You can find the full Dockerfile in the '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://github.com/codedge/aws-fargate-with-laravel/blob/master/Dockerfile'
              target: _blank
              rel: null
        text: repository
      -
        type: text
        text: .
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```dockerfile
          ### PHP
          
          # Use the php7.4-fpm-alpine image and aliasing it as 'laravelapp_php'
          FROM php:7.4-fpm-alpine AS laravelapp_php
          
          # Your instruction to build the image for php
          # Then you need to copy the items needed from another image to this. In our case we copy the 'composer' executable
          
          COPY --from=composer:latest /usr/bin/composer /usr/bin/composer
          
          # copy everything, excluding the one from .dockerignore file
          COPY . ./
          
          RUN set -eux; \
              mkdir -p storage/logs storage/framework bootstrap/cache; \
              composer install --prefer-dist --no-progress --no-suggest --optimize-autoloader; \
              composer clear-cache
          
          # ... and so on ...
          
          ### NGINX
          
          FROM nginx:1.17-alpine AS laravelapp_nginx
          
          # Copy our files from the laravelapp_php image to this one here
          # Nginx only needs to have the files in 'public/'. The other php files to only exist in the php image
          COPY --from=laravelapp_php /srv/laravelapp/public public/
          
        caption: Dockerfile
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Due to the fact that we only hold the files needed for the containers we keep to size of the images relatively small. For the php image, the size mainly depends on the modules needed as we need to include the build and development files for creating the extensions. This might increase our image size.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'For my setup I ended with these sizes:'
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```bash
          REPOSITORY                TAG            IMAGE ID            CREATED           SIZE
          laravelapp-nginx       latest         252bcd38e8aa        42 hours ago      19.8MB
          laravelapp-php-fpm     latest         9c2afe650880        43 hours ago      220MB
          laravelapp-nodejs      latest         9a0b33434754        46 hours ago      381MB
          ```
          
        caption: 'docker images'
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        text: 'Container orchestration'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Although included in the project and supported by AWS Fargate, '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://docs.docker.com/compose/'
              target: _blank
              rel: null
        text: 'Docker compose'
      -
        type: text
        text: ' is not going to be used in our AWS deployment. For orchestration of the containers we are going to use Amazons ECS tasks definition in which you can link containers. I will come to that [a bit later]('
      -
        type: text
        marks:
          -
            type: underline
        text: 'http://localhost:1313/posts/run-php-application-on-aws-fargate/#task-definition'
      -
        type: text
        text: ).
  -
    type: paragraph
    content:
      -
        type: text
        text: 'You can use the the docker-compose file for local testing of the containers. In there you can see how we addressed to different stages of the Docker image - using '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://docs.docker.com/compose/compose-file/#target'
              target: _blank
              rel: null
        text: target
      -
        type: text
        text: ', although we have only one Dockerfile.'
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```yaml
          version: '3.4'
          
          services:
            php-fpm:
              build:
                context: .
                target: laravelapp_php
          
          ...
          ```
          
        caption: null
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Through the '
      -
        type: text
        marks:
          -
            type: code
        text: depends_on
      -
        type: text
        text: ' item the containers are linked.'
      -
        type: hard_break
      -
        type: text
        marks:
          -
            type: bold
        text: 'Do not use '
      -
        type: text
        marks:
          -
            type: bold
          -
            type: link
            attrs:
              href: 'https://docs.docker.com/compose/compose-file/#links'
              target: _blank
              rel: null
        text: links
      -
        type: text
        marks:
          -
            type: bold
        text: '. '
      -
        type: text
        text: 'Using '
      -
        type: text
        marks:
          -
            type: code
        text: links
      -
        type: text
        text: ' in your docker-compose.yml is '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://docs.docker.com/compose/compose-file/#links'
              target: _blank
              rel: null
        text: 'considered deprecated'
      -
        type: text
        text: ' and being removed more or less soon. Either use '
      -
        type: text
        marks:
          -
            type: code
        text: depends_on
      -
        type: text
        text: ' or create a '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://docs.docker.com/compose/networking/'
              target: _blank
              rel: null
        text: 'user-defined network'
      -
        type: text
        text: '. For local testing you just need to run '
      -
        type: text
        marks:
          -
            type: code
        text: 'docker-compose up'
      -
        type: text
        text: '. Afterwards you''ll find the three images, linked, up and running.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'The push to the repository is part of our deployment pipeline which is our next topic.'
  -
    type: heading
    attrs:
      level: 2
    content:
      -
        type: text
        text: 'Deployment with Github Actions'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'For deployment we are going to use '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://github.com/features/actions'
              target: _blank
              rel: null
        text: 'Github Actions'
      -
        type: text
        text: ' to create the Docker images, push them to a Docker registry (ECR in our case), creating a deployment task for ECS to pick up the images and spin up a new service that runs our three containers on ECS.'
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        text: 'The workflow'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Most of you are already familiar with so we are going to step right into our workflow file at '
      -
        type: text
        marks:
          -
            type: code
        text: .github/workflows/deploy.yml
      -
        type: text
        text: .
  -
    type: paragraph
    content:
      -
        type: text
        text: 'To make the workflow work you need to register secrets in Github for your AWS key, AWS secret key and AWS region. Furthermore you need to adjust the '
      -
        type: text
        marks:
          -
            type: code
        text: ECR_REPOSITORY
      -
        type: text
        text: ' names (3 in total) according to the repositories you have created in AWS. For that, we quickly switch to our ECR console and create three repositories.'
  -
    type: set
    attrs:
      values:
        type: image
        image: 20200419-run-php-application-on-aws-fargate/aws_ecr.png
        caption: 'AWS Elastic Container Registry'
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        text: 'Tag immutability'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'This feature is supported since'
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://aws.amazon.com/about-aws/whats-new/2019/07/amazon-ecr-now-supports-immutable-image-tags/'
              target: _blank
              rel: null
        text: ' mid of 2019'
      -
        type: text
        text: ' and prevents tags from being overwritten. As we''re tagging the images with '
      -
        type: text
        marks:
          -
            type: code
        text: latest
      -
        type: text
        text: ' and wanting this tag to reflect the latest changes we set this to '
      -
        type: text
        marks:
          -
            type: code
        text: disabled
      -
        type: text
        text: .
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        text: 'Scan on push'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://docs.aws.amazon.com/AmazonECR/latest/userguide/image-scanning.html'
              target: _blank
              rel: null
        text: 'Image scanning'
      -
        type: text
        text: ' helps in identifying software vulnerabilities in your container images. We are going to use this here. You can certainly disable it too, if you don''t like it for whatever reasons.'
      -
        type: hard_break
      -
        type: hard_break
      -
        type: text
        text: 'After you created the secret in your Github repository, set up the repositories on AWS ECR, adjusted the names for the repositories in your workflow let''s quickly have a look at each of the workflow steps:'
      -
        type: hard_break
  -
    type: ordered_list
    attrs:
      order: 1
    content:
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: Checkout
              -
                type: text
                text: ': Checkout your repository from Github'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Configure AWS credentials'
              -
                type: text
                text: ': Configure AWS credential environment variables for use in other GitHub Actions'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Login to Amazon ECR'
              -
                type: text
                text: ': Log into Amazon ECR with the local Docker client'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Build, tag, push image: nginx'
              -
                type: text
                text: ': Build the Docker image for nginx and pushes it to Amazon ECR'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Build, tag, push image: php-fpm'
              -
                type: text
                text: ': Build the Docker image for php-fpm and pushes it to Amazon ECR'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Build, tag, push image: nodejs'
              -
                type: text
                text: ': Build the Docker image for nodejs and pushes it to Amazon ECR'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Render task definition: nginx'
              -
                type: text
                text: ': Renders the final repository URL including the name of repository into the '
              -
                type: text
                marks:
                  -
                    type: italic
                  -
                    type: link
                    attrs:
                      href: 'https://github.com/codedge/aws-fargate-with-laravel/blob/master/task-definition.json'
                      target: _blank
                      rel: null
                text: 'task-definition.json file'
              -
                type: text
                text: '. We''ll come to that in the next topic.'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Render task definition: php-fpm'
              -
                type: text
                text: ': Renders the final repository URL including the name of repository into the '
              -
                type: text
                marks:
                  -
                    type: italic
                  -
                    type: link
                    attrs:
                      href: 'https://github.com/codedge/aws-fargate-with-laravel/blob/master/task-definition.json'
                      target: _blank
                      rel: null
                text: 'task-definition.json file'
              -
                type: text
                text: .
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Render task definition: nodejs'
              -
                type: text
                text: ': Renders the final repository URL including the name of repository into the '
              -
                type: text
                marks:
                  -
                    type: italic
                  -
                    type: link
                    attrs:
                      href: 'https://github.com/codedge/aws-fargate-with-laravel/blob/master/task-definition.json'
                      target: _blank
                      rel: null
                text: 'task-definition.json file'
              -
                type: text
                text: '. '
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Deploy Amazon ECS task definition'
              -
                type: text
                text: ': A task definition is required to run Docker containers in Amazon ECS. You define your containers, its hardware resources, inter-container connections as well as host connections, where to send logs to, and many more. See the [next section]({{< ref "#task-definition-for-ecs" >}}) about this topic. But first let''s check for two important settings, '
              -
                type: text
                marks:
                  -
                    type: code
                text: service
              -
                type: text
                text: ' and '
              -
                type: text
                marks:
                  -
                    type: code
                text: cluster
              -
                type: text
                text: .
              -
                type: hard_break
              -
                type: text
                marks:
                  -
                    type: code
                text: cluster
              -
                type: text
                text: ' is the name you are going to choose in Amazon ECS. [See here]({{< ref "#create-cluster-step-2" >}})'
              -
                type: hard_break
              -
                type: text
                marks:
                  -
                    type: code
                text: service
              -
                type: text
                text: ' is the name for the service that picks up the task and deploys it into the cluster. [See here]({{< ref "#create-a-cluster-service" >}})'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Logout of Amazon ECR'
              -
                type: text
                text: ': Log out from Amazon ECR and erase any credentials connected with it'
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Task definition for ECS'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'In ECS, the basic unit of a deployment is a task, a logical construct that models one or more containers. This means that the ECS APIs operate on tasks rather than individual containers. In ECS, you can’t run a container: rather, you run a task, which, in turns, run your container(s). A task contains one or more containers.'
  -
    type: set
    attrs:
      values:
        type: image
        image: 20200419-run-php-application-on-aws-fargate/containers_and_tasks.png
        caption: 'Containers and Tasks on ECS'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'In our workflow the steps 7, 8 and 9 are responsible to adjust the '
      -
        type: text
        marks:
          -
            type: italic
          -
            type: link
            attrs:
              href: 'https://github.com/codedge/aws-fargate-with-laravel/blob/master/task-definition.json'
              target: _blank
              rel: null
        text: 'task-definition.json file'
      -
        type: text
        text: '. This file can be compared to the '
      -
        type: text
        marks:
          -
            type: code
        text: docker-compose.yml
      -
        type: text
        text: ' or any other orchestration file you use to connect your Docker containers. One special thing here is the following line appearing in each of step 7, 8 and 9:'
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```yml
          task-definition: task-definition.json
          container-name: nginx
          image: ${{ steps.build-image-nginx.outputs.image }}
          
        caption: 'Step 7'
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```yml
          task-definition: ${{ steps.task-def-nginx.outputs.task-definition }}
          container-name: php-fpm
          image: ${{ steps.build-image-php-fpm.outputs.image }}
          
        caption: 'Step 8'
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```yml
          task-definition: ${{ steps.task-def-php-fpm.outputs.task-definition }}
          container-name: nodejs
          image: ${{ steps.build-image-nodejs.outputs.image }}
          
        caption: 'Step 9'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'What it does in 8 and 9 is, that it takes the former out and exchange the '
      -
        type: text
        marks:
          -
            type: code
        text: image
      -
        type: text
        text: ' field inside. In step 7 it uses the '
      -
        type: text
        marks:
          -
            type: code
        text: task-definition.json
      -
        type: text
        text: ' as it is. This is needed to iteratively inserting the image used from our Docker registry and finally pushing the complete task definition in step 10.'
      -
        type: hard_break
      -
        type: text
        text: 'Moving on to the '
      -
        type: text
        marks:
          -
            type: code
        text: task-definition.json
      -
        type: text
        text: ' file itself. There is a whole documentation sections on this file '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html'
              target: _blank
              rel: null
        text: 'AWS docs page'
      -
        type: text
        text: '. I''ll continue with the parts that are relevant for us here.'
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```json
          {
              "family": "laravel-backend-app",
              "containerDefinitions": [
                  {
                      // container 1, nginx
                  },
                  {
                      // container 2, php-fpm
                  },
                  {
                      // container 3, nodejs
                  }
              ],
              "executionRoleArn": "ecsTaskExecutionRole",
              "cpu": "2048",
              "memory": "4096",
              "networkMode": "awsvpc",
              "requiresCompatibilities": [
                  "FARGATE"
              ]
          }
          
        caption: null
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Let''s go through the file, but starting at the end:'
  -
    type: bullet_list
    content:
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'requiresCompatibilities: '
              -
                type: text
                text: 'This needs to be set to '
              -
                type: text
                marks:
                  -
                    type: code
                text: FARGATE
              -
                type: text
                text: '. Otherwise ECS won''t recognize it properly.'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'networkMode: '
              -
                type: text
                text: 'This is set to '
              -
                type: text
                marks:
                  -
                    type: code
                text: awsvpc
              -
                type: text
                text: ', so every task that is launched from that task definition gets its own elastic network interface (ENI) and a primary private IP address. That makes it possible to call services and applications as if they would be in one system (not in distributed containers).'
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: underline
                text: 'Example for nginx calling php-fpm'
              -
                type: text
                text: ': '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'fastcgi_pass 127.0.0.1:9000;'
          -
            type: paragraph
            content:
              -
                type: text
                text: 'If we would orchestrate with Docker Compose we normally call a container by its name. So the above statement would probably be '
              -
                type: text
                marks:
                  -
                    type: code
                text: 'fastcgi_pass php:9000;'
              -
                type: text
                text: .
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'cpu: '
              -
                type: text
                text: 'The cpu value can be expressed in CPU units or vCPUs in a task definition but is converted to an integer indicating the CPU units when the task definition is registered.'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'memory: '
              -
                type: text
                text: 'The memory value can be expressed in MiB or GB in a task definition but is converted to an integer indicating the MiB when the task definition is registered.'
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Both values, '
              -
                type: text
                marks:
                  -
                    type: code
                text: cpu
              -
                type: text
                text: ' and '
              -
                type: text
                marks:
                  -
                    type: code
                text: memory
              -
                type: text
                text: ' can be defined for each container separately or for the complete task. In this sample application here, I defined the values for the complete task. This runs just fine. And remember, you can change (scale) this as you need. This is just a point to start from.'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'executionRoleArn: '
              -
                type: text
                text: 'This is connected to permissions on AWS. We leave this to the value '
              -
                type: text
                marks:
                  -
                    type: code
                text: ecsTaskExecutionRole
              -
                type: text
                text: '. I''ll come to this in the section about [configuring AWS Fargate]({{< ref "#roles-for-ecr-and-ecs" >}}).'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'family: '
              -
                type: text
                text: 'This is the name for our task that can be freely choosen. So you can deploy multiple '
              -
                type: text
                marks:
                  -
                    type: code
                text: laravel-backend-app
              -
                type: text
                text: ' if you like and do balancing and stuff. It is just common name for a set of containers, in our case here for three.'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'containerDefinitions: '
              -
                type: text
                text: 'Here comes the fun part... the containers. I am going to summarize the important things you''ll encounter in inside the '
              -
                type: text
                marks:
                  -
                    type: code
                text: task-definition.json
              -
                type: text
                text: ':'
              -
                type: hard_break
              -
                type: text
                marks:
                  -
                    type: code
                text: nginx
              -
                type: text
                text: ': Open port '
              -
                type: text
                marks:
                  -
                    type: code
                text: '80'
              -
                type: text
                text: ' to host to be accessible from outside'
              -
                type: hard_break
              -
                type: text
                marks:
                  -
                    type: code
                text: php-fpm
              -
                type: text
                text: ': Open port '
              -
                type: text
                marks:
                  -
                    type: code
                text: '9000'
              -
                type: text
                text: ' only for inter-container communication to be accessible from nginx, Secrets and environment variable like keys, settings for debugging, env to be used are properly set'
              -
                type: hard_break
              -
                type: text
                marks:
                  -
                    type: code
                text: nodejs
              -
                type: text
                text: ': nothing special'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'All containers have '
      -
        type: text
        marks:
          -
            type: code
        text: essential
      -
        type: text
        text: ' set to '
      -
        type: text
        marks:
          -
            type: code
        text: 'true'
      -
        type: text
        text: '. This means, that if one container fails or stops for any reason, all other containers that are part of the task are stopped. Next is all the configuration about AWS Fargate and all the connected services we are going to use.'
  -
    type: heading
    attrs:
      level: 2
    content:
      -
        type: text
        text: 'AWS Fargate'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'AWS Fargate cannot be configured directly as it is more an underlying technology to run serverless applications on Amazon AWS. In the next chapters we are going to step into each part that needs configuration to get the whole Laravel application running.'
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        text: 'Security: IAMs, roles and permissions'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Talking about security on AWS could fill an entire series of posts. I''ll keep this to a minumum where I''d personally think this is a reasonable way to operate an application.'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Separate user and group for your application'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'In your '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://console.aws.amazon.com/iam/home'
              target: _blank
              rel: null
        text: 'Identity and Access Management (IAM)'
      -
        type: text
        text: ' create a new user called '
      -
        type: text
        marks:
          -
            type: code
        text: laravelapp
      -
        type: text
        text: ' that is the one who is allowed to run all tasks around your application.'
  -
    type: set
    attrs:
      values:
        type: hint
        hint:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Never run applications with your AWS root user. Read the AWS docs for '
              -
                type: text
                marks:
                  -
                    type: link
                    attrs:
                      href: 'https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html'
                      target: _blank
                      rel: null
                text: 'further information'
              -
                type: text
                text: .
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Assign and manage permissions'
      -
        type: text
        text: ' via a group, f. ex. '
      -
        type: text
        marks:
          -
            type: code
        text: LaravelAppManageServices
      -
        type: text
        text: '. Make the user '
      -
        type: text
        marks:
          -
            type: code
        text: laravelapp
      -
        type: text
        text: ' member of this group and then assign permissions to this group instead of directly to the user.'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Roles for ECR and ECS'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'By default the newly created user '
      -
        type: text
        marks:
          -
            type: code
        text: laravelapp
      -
        type: text
        text: ' has no rights to execute any operation on ECR or ECS. In our case, this user need to be able to push images to ECR or to run services on ECS to execute [our task]({{< ref "#task-definition-for-ecs" >}}) to spin up the container. For that we need to attach to two policies to our group:'
  -
    type: bullet_list
    content:
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: AmazonEC2ContainerRegistryFullAccess
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: AmazonECS_FullAccess
  -
    type: set
    attrs:
      values:
        type: image
        image: 20200419-run-php-application-on-aws-fargate/iam_groups.png
        caption: 'IAM groups'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Surely we would need to tighten the permissions a bit later on. I''ll get to that in a separate post.'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Execution role'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html'
              target: _blank
              rel: null
        text: 'AWS docs'
      -
        type: text
        text: ' ...'
  -
    type: blockquote
    content:
      -
        type: paragraph
        content:
          -
            type: text
            text: 'The Amazon ECS container agent, and the Fargate agent for your Fargate tasks, make calls to the Amazon ECS API on your behalf. The agent requires an IAM role for the service to know that the agent belongs to you. This IAM role is referred to as a task execution IAM role.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'So the, create a new role called '
      -
        type: text
        marks:
          -
            type: code
        text: ecsTaskExecutionRole
      -
        type: text
        text: ' and attach the following policies:'
  -
    type: bullet_list
    content:
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: AmazonECSTaskExecutionRolePolicy
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'AmazonSSMReadOnlyAccess: we are going to need that to read our environment variables from [AWS Systems Manager Parameter Store]({{< ref "#environment-variables-and-secrets" >}})'
  -
    type: set
    attrs:
      values:
        type: image
        image: 20200419-run-php-application-on-aws-fargate/iam_ecstaskexecutionrole.png
        caption: ecsTaskExecutionRole
  -
    type: set
    attrs:
      values:
        type: hint
        hint:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'The name of this role '
              -
                type: text
                marks:
                  -
                    type: code
                text: ecsExecutionRole
              -
                type: text
                text: ' needs to match the value in our workflow.'
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```yml
          "executionRoleArn": "ecsTaskExecutionRole",
          "cpu": "2048",
          "memory": "4096",
          "networkMode": "awsvpc",
          
        caption: null
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        text: 'Create the ECS cluster'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Head over to your AWS Management Console, open '
      -
        type: text
        marks:
          -
            type: italic
        text: Services
      -
        type: text
        text: ', type '
      -
        type: text
        marks:
          -
            type: italic
        text: ECS
      -
        type: text
        text: ' and click on '
      -
        type: text
        marks:
          -
            type: italic
        text: 'Elastic Container Service'
      -
        type: text
        text: .
  -
    type: set
    attrs:
      values:
        type: image
        image: 20200419-run-php-application-on-aws-fargate/aws_dashboard_ecs.png
        caption: 'AWS Dashboard: Select ECS'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'On the left side menu click on '
      -
        type: text
        marks:
          -
            type: italic
        text: 'Amazon ECS > Clusters'
      -
        type: text
        text: ' and hit the '
      -
        type: text
        marks:
          -
            type: italic
        text: 'Create Cluster'
      -
        type: text
        text: ' button.'
  -
    type: set
    attrs:
      values:
        type: image
        image: 20200419-run-php-application-on-aws-fargate/aws_ecs_create_cluster.png
        caption: 'Amazon ECS: Create cluster'
  -
    type: heading
    attrs:
      level: 4
    content:
      -
        type: text
        text: 'Create cluster: Step 1'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'In the first step select the _Networking only" card. As we are going to use AWS Fargate we only need networking, no EC2, no Windows.'
  -
    type: heading
    attrs:
      level: 4
    content:
      -
        type: text
        text: 'Create cluster: Step 2'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Now enter a cluster name, which you can freely choose.'
  -
    type: set
    attrs:
      values:
        type: hint
        hint:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'The name of the cluster needs to match the one defined in our workflow.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'You can either set the cluster name in your Github secrets or directly enter the name, f. ex. '
      -
        type: text
        marks:
          -
            type: code
        text: laravel-app
      -
        type: text
        text: .
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```yml {hl_lines=[6], linenostart=85}
          - name: "Deploy Amazon ECS task definition"
            uses: aws-actions/amazon-ecs-deploy-task-definition@v1
            with:
              task-definition: ${{ steps.task-def-nodejs.outputs.task-definition }}
              service: laravelapp-backend
              cluster: ${{ secrets.ECS_CLUSTER_NAME }}
              wait-for-service-stability: false
          
        caption: null
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: Networking
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Tick the '
      -
        type: text
        marks:
          -
            type: italic
        text: 'Create VPC'
      -
        type: text
        text: ' checkbox and leave the settings for CIDR, Subnet 1, Subnet 2 as they are. Next tick the checkbox next to '
      -
        type: text
        marks:
          -
            type: italic
        text: 'CloudWatch Container Insights'
      -
        type: text
        text: '. This will send all log outputs to Cloudwatch.... and then hit the '
      -
        type: text
        marks:
          -
            type: italic
        text: Create
      -
        type: text
        text: ' button. Now the cluster gets created. This might take some minutes. Meanwhile we can continue with creating the service thats going to deploy our task.'
  -
    type: set
    attrs:
      values:
        type: image
        image: 20200419-run-php-application-on-aws-fargate/aws_ecs_create_cluster_steps.png
        caption: 'Amazon ECS: Create cluster last step'
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        text: 'Create a cluster service'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Next is to create our service that''ll receive the task and execute it. Head over to your freshly created cluster and hit the '
      -
        type: text
        marks:
          -
            type: italic
        text: 'Create service'
      -
        type: text
        text: ' button.'
  -
    type: set
    attrs:
      values:
        type: image
        image: 20200419-run-php-application-on-aws-fargate/create_service.png
        caption: 'Create service'
  -
    type: heading
    attrs:
      level: 4
    content:
      -
        type: text
        text: 'Create service: Step 1'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Launch type:'
      -
        type: text
        text: ' Fargate'
      -
        type: hard_break
      -
        type: text
        marks:
          -
            type: bold
        text: 'Task definition: '
      -
        type: hard_break
        marks:
          -
            type: bold
      -
        type: text
        text: 'This is prepopulated with the '
      -
        type: text
        marks:
          -
            type: code
        text: family
      -
        type: text
        text: ' name in our '
      -
        type: text
        marks:
          -
            type: code
        text: task-definition.json
      -
        type: text
        text: .
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```json {hl_lines=[2], linenostart=1}
          {
              "family": "laravel-backend-app",
              "containerDefinitions": [
                  {
                      // container 1, nginx
                  },
          
        caption: null
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Service name:'
      -
        type: hard_break
        marks:
          -
            type: bold
      -
        type: text
        text: 'This should match the '
      -
        type: text
        marks:
          -
            type: code
        text: service
      -
        type: text
        text: ' name from our workflow file.'
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```yml {hl_lines=[5], linenostart=85}
          - name: "Deploy Amazon ECS task definition"
            uses: aws-actions/amazon-ecs-deploy-task-definition@v1
            with:
              task-definition: ${{ steps.task-def-nodejs.outputs.task-definition }}
              service: laravelapp-backend
              cluster: ${{ secrets.ECS_CLUSTER_NAME }}
          
        caption: null
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Number of tasks: '
      -
        type: text
        text: 'Leave that to '
      -
        type: text
        marks:
          -
            type: code
        text: '1'
      -
        type: text
        text: ' for now. We will not run more than one instance of this service.'
  -
    type: heading
    attrs:
      level: 4
    content:
      -
        type: text
        text: 'Create service: Step 2'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Cluster VPC: '
      -
        type: text
        text: 'Make sure you select the correct Virtual Private Cluster (VPC) group that was created together with your cluster. It should be selected automatically.'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Subnets: '
      -
        type: text
        text: 'Select the subnet that are unselected, normally two.'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Load balancers: '
      -
        type: text
        text: 'We will go with '
      -
        type: text
        marks:
          -
            type: italic
        text: None
      -
        type: text
        text: ' for the moment and come back later to add a Load Balancer to our service.'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Service discovery: '
      -
        type: text
        text: 'Disable service discovery as we won''t use Amazon Route 53 for this project. If needed you can add this later on, of course.'
  -
    type: heading
    attrs:
      level: 4
    content:
      -
        type: text
        text: 'Create service: Step 3'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Auto-scaling: '
      -
        type: text
        text: 'Skip that. We won''t use that.'
  -
    type: heading
    attrs:
      level: 4
    content:
      -
        type: text
        text: 'Create service: Step 4'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Review all your settings and hit '
      -
        type: text
        marks:
          -
            type: italic
        text: 'Create service'
      -
        type: text
        text: .
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        text: 'Environment variables and secrets'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Managing secrets and/or environment variables on AWS can be done with either '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://aws.amazon.com/secrets-manager/'
              target: _blank
              rel: null
        text: 'AWS Secrets Manager'
      -
        type: text
        text: ' or with '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html'
              target: _blank
              rel: null
        text: 'AWS Systems Manager Parameter Store'
      -
        type: text
        text: '. I decided to go with the parameter store for one main reason: it is (almost) free of charge.'
  -
    type: bullet_list
    content:
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Parameter store'
              -
                type: text
                text: ': Free of charge, limit of 10,000 parameters per account'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                marks:
                  -
                    type: bold
                text: 'Secrets manager'
              -
                type: text
                text: ': $0.40 per secret stored and additional $0.05 for 10,000 API calls'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'For those who want to read more about differences and pros and cons of both solutions have a look at this '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://www.1strategy.com/blog/2019/02/28/aws-parameter-store-vs-aws-secrets-manager/'
              target: _blank
              rel: null
        text: 'blog post'
      -
        type: text
        text: ' for comparison of both.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Whether it is a configuration like '
      -
        type: text
        marks:
          -
            type: code
        text: APP_DEBUG
      -
        type: text
        text: ' or an actual secret like the '
      -
        type: text
        marks:
          -
            type: code
        text: APP_KEY
      -
        type: text
        text: '. Both is going to be stored in the parameter store and injected into the container in our '
      -
        type: text
        marks:
          -
            type: code
        text: task-defintion.json
      -
        type: text
        text: .
  -
    type: set
    attrs:
      values:
        type: code
        code: |
          ```json
           "secrets": [
              {
                  "name": "APP_ENV",
                  "valueFrom": "laravelapp_app_env"
              },
              {
                  "name": "APP_DEBUG",
                  "valueFrom": "laravelapp_app_debug"
              },
              {
                  "name": "APP_KEY",
                  "valueFrom": "laravelapp_app_key"
              }
          ],
          
        caption: null
  -
    type: paragraph
    content:
      -
        type: text
        text: 'After you entered your settings the parameter store should like like this.'
  -
    type: set
    attrs:
      values:
        type: image
        image: 20200419-run-php-application-on-aws-fargate/parameter_store.png
        caption: 'AWS Systems Manager Parameter Store'
  -
    type: set
    attrs:
      values:
        type: hint
        hint:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'Store your'
              -
                type: text
                marks:
                  -
                    type: bold
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: APP_KEY
              -
                type: text
                marks:
                  -
                    type: bold
                text: ' '
              -
                type: text
                text: as
              -
                type: text
                marks:
                  -
                    type: bold
                  -
                    type: italic
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: SecureString
              -
                type: text
                marks:
                  -
                    type: bold
                  -
                    type: italic
                text: ' '
              -
                type: text
                text: instead
              -
                type: text
                marks:
                  -
                    type: bold
                text: ' '
              -
                type: text
                text: 'of type'
              -
                type: text
                marks:
                  -
                    type: bold
                  -
                    type: italic
                text: ' '
              -
                type: text
                marks:
                  -
                    type: code
                text: String
              -
                type: text
                marks:
                  -
                    type: bold
                  -
                    type: italic
                text: .
              -
                type: hard_break
                marks:
                  -
                    type: bold
                  -
                    type: italic
              -
                type: hard_break
                marks:
                  -
                    type: bold
                  -
                    type: italic
              -
                type: text
                text: 'A SecureString parameter is any sensitive data that needs to be stored and referenced in a secure manner. If you have data that you don''t want users to alter or reference in plain text, such as passwords or license keys, create those parameters using the '
              -
                type: text
                marks:
                  -
                    type: code
                text: SecureString
              -
                type: text
                text: ' datatype.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Although I used the normal '
      -
        type: text
        marks:
          -
            type: code
        text: String
      -
        type: text
        text: ' type you can do better for the above mentioned reasons.'
  -
    type: heading
    attrs:
      level: 2
    content:
      -
        type: text
        text: 'Quick check'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'To quickly check if you can reach your site, navigate to your cluster, and check the task that is currently running. There you will find your public IP address that directly points to port '
      -
        type: text
        marks:
          -
            type: code
        text: '80'
      -
        type: text
        text: ' of your app. When you enter that page you should be welcomed with the Laravel landing page from our fresh install.'
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        text: 'Add an Elastic Load Balancer (ELB)'
  -
    type: paragraph
    content:
      -
        type: text
        marks:
          -
            type: bold
        text: 'Note: '
      -
        type: text
        text: 'We won''t handle neither HTTPS nor Amazon Route 53 here.'
      -
        type: hard_break
      -
        type: hard_break
      -
        type: text
        text: 'After adding the load balancer you can point your domain to CNAME of ELB. The ELB is going to direct all traffic to port '
      -
        type: text
        marks:
          -
            type: code
        text: '80'
      -
        type: text
        text: ' of our application where our nginx is listening.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'A load balancer can be created in the '
      -
        type: text
        marks:
          -
            type: italic
        text: EC2
      -
        type: text
        text: ' service. On the left select '
      -
        type: text
        marks:
          -
            type: italic
        text: 'Load balancers'
      -
        type: text
        text: ' and hit the button '
      -
        type: text
        marks:
          -
            type: italic
        text: 'Create Load Balancer'
      -
        type: text
        text: '. Next select '
      -
        type: text
        marks:
          -
            type: bold
        text: 'Application Load Balancer'
      -
        type: text
        text: .
  -
    type: heading
    attrs:
      level: 4
    content:
      -
        type: text
        text: 'Create an ELB: Step 1'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'In the first step make sure you'
  -
    type: bullet_list
    content:
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'have a listener for '
              -
                type: text
                marks:
                  -
                    type: italic
                text: HTTP
              -
                type: text
                text: ' on port '
              -
                type: text
                marks:
                  -
                    type: code
                text: '80'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'have the correct Virtual Private Cloud (VPC) selected.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Additionally add the availability zones for your different subnets. Next would be step 2 which we are going to skip, as it is only about HTTPS.'
  -
    type: heading
    attrs:
      level: 4
    content:
      -
        type: text
        text: 'Create an ELB: Step 3 (Security group)'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'We create a new security group '
      -
        type: text
        marks:
          -
            type: code
        text: laravelapp-sg
      -
        type: text
        text: ' with only one rule that allows traffic coming from '
      -
        type: text
        marks:
          -
            type: code
        text: Anywhere
      -
        type: text
        text: ' of type '
      -
        type: text
        marks:
          -
            type: code
        text: HTTP
      -
        type: text
        text: ' to reach our instance via '
      -
        type: text
        marks:
          -
            type: code
        text: TCP
      -
        type: text
        text: ' on port '
      -
        type: text
        marks:
          -
            type: code
        text: '80'
      -
        type: text
        text: .
  -
    type: table
    content:
      -
        type: table_row
        content:
          -
            type: table_cell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
              background: null
            content:
              -
                type: paragraph
                content:
                  -
                    type: text
                    text: Type
          -
            type: table_cell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
              background: null
            content:
              -
                type: paragraph
                content:
                  -
                    type: text
                    text: Protocol
          -
            type: table_cell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
              background: null
            content:
              -
                type: paragraph
                content:
                  -
                    type: text
                    text: 'Port range'
          -
            type: table_cell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
              background: null
            content:
              -
                type: paragraph
                content:
                  -
                    type: text
                    text: Source
      -
        type: table_row
        content:
          -
            type: table_cell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
              background: null
            content:
              -
                type: paragraph
                content:
                  -
                    type: text
                    text: HTTP
          -
            type: table_cell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
              background: null
            content:
              -
                type: paragraph
                content:
                  -
                    type: text
                    text: TCP
          -
            type: table_cell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
              background: null
            content:
              -
                type: paragraph
                content:
                  -
                    type: text
                    text: '80'
          -
            type: table_cell
            attrs:
              colspan: 1
              rowspan: 1
              colwidth: null
              background: null
            content:
              -
                type: paragraph
                content:
                  -
                    type: text
                    text: Anywhere
  -
    type: heading
    attrs:
      level: 4
    content:
      -
        type: text
        text: 'Create an ELB: Step 4 (Target group)'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Here we create a new target group '
      -
        type: text
        marks:
          -
            type: code
        text: laravelapp-tg
      -
        type: text
        text: ' with a target type '
      -
        type: text
        marks:
          -
            type: code
        text: IP
      -
        type: text
        text: '. Our load balancer routes requests to the targets in this target group using the protocol and port that you specify.'
  -
    type: heading
    attrs:
      level: 4
    content:
      -
        type: text
        text: 'Create an ELB: Step 5+6'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'The '
      -
        type: text
        marks:
          -
            type: italic
        text: 'Register Targets'
      -
        type: text
        text: ' step can be skipped and on step 6 you please check all the settings again. If everything looks good, you can save the configuration of the ELB.'
  -
    type: heading
    attrs:
      level: 2
    content:
      -
        type: text
        text: Conclusions
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Now when pushing changes to your Github repository the deploy workflow start, build the images, pushed them to the ECR Docker registry, creates the task that is picked up by the service and creates your application.'
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        text: Costs
  -
    type: paragraph
    content:
      -
        type: text
        text: 'So, what''s the price you have to pay for this setup? As I mentioned earlier, this is hard to say, as it depends on usage, dimensioning and the region. '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://www.concurrencylabs.com/blog/choose-your-aws-region-wisely/'
              target: _blank
              rel: null
        text: Here
      -
        type: text
        text: ' is a nice overview, how the different AWS regions varies by costs.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'To make it short, the top 5:'
  -
    type: bullet_list
    content:
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: 'N. Virginia'
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: Ohio
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: Oregon
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: Mumbai
      -
        type: list_item
        content:
          -
            type: paragraph
            content:
              -
                type: text
                text: Stockholm
      -
        type: list_item
        content:
          -
            type: paragraph
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Use the '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://calculator.aws/'
              target: _blank
              rel: null
        text: 'AWS pricing calculator'
      -
        type: text
        text: ' to get a proper pricing.'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'If you''re in a first phase of your project you are probably eligible for the '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'http://aws.amazon.com/free'
              target: _blank
              rel: null
        text: 'AWS Free Usage Tier'
      -
        type: text
        text: '. This will surely give you a lot of space to play around and test. Here is a list of the usage for the service I created and played around with for this post.'
  -
    type: set
    attrs:
      values:
        type: image
        image: 20200419-run-php-application-on-aws-fargate/free_tiers.png
        caption: 'Free tier usage'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'As you can see the most important for now is the space for our Docker registry on ECR. So to keep our images small is basically saving us money.'
  -
    type: heading
    attrs:
      level: 3
    content:
      -
        type: text
        text: 'Additional ideas'
  -
    type: paragraph
    content:
      -
        type: text
        text: 'Just a quick rundown on improvements further ideas to be done. Provide HTTPS access, refine the groups, policies in IAM to tighten access and strengthen security, see the '
      -
        type: text
        marks:
          -
            type: link
            attrs:
              href: 'https://github.com/aws/aws-sdk-php-laravel'
              target: _blank
              rel: null
        text: 'AWS SDK for Laravel'
      -
        type: text
        text: ' to make handling for AWS in Laravel easier'
  -
    type: paragraph
    content:
      -
        type: text
        text: '... and probably many many more things :-)'
tags:
  - php
  - 'aws fargate'
  - aws
  - github
webmention_url: 'https://www.codedge.de/posts/20200419-run-php-application-on-aws-fargate/'
id: 372e62c6-22c3-4226-a8fb-b7ffddb37608
---
